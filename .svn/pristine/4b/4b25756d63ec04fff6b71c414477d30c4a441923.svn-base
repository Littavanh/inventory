<?php
session_start();
require_once("../config.php");
require_once("m_receive.php");
$SumResult = SumMaterial($whereclause, '');
$date = date('Y-m-d');
$output_filename = "Receive" . $date . ".xls";
// Redirect the output to the stream
header("Content-type: application/vnd.ms-excel");
header("Content-Disposition: attachment; filename={$output_filename}");
if (isset($_GET['startdate'])) {
	$FormDate = $_GET['startdate'];
} else {
	$FormDate = date('Y-m-d');
}
if (isset($_GET['enddate'])) {
	$ToDate = $_GET['enddate'];
} else {
	$ToDate = date('Y-m-d');
}
echo "<h4>ລາຍງານຮັບເຄື່ອງເຂົ້າສາງ  ປະຈໍາວັນທີ່ " . $FormDate . " ຫາ " . $ToDate . "</h4> ";
echo "<table border='1'> \n";
?>
<tr>
	<th>ລຳດັບ</th>
	<th>ລະຫັດສິນຄ້າ</th>
	<th>*ລາຍລະອຽດສິນຄ້າ</th>
	<th>ຫົວໜ່ວຍ</th>
	<th>ລາຄາ</th>
	<th colspan="2">ຍອດເຫລືອຕົ້ນເດືອນ</th>
	<th colspan="2">ຮັບສິນຄ້າເຂົ້າ</th>
	<th colspan="2">ຈ່າຍສິນຄ້າອອກ</th>
	<th colspan="2">ຍອດຄົງເຫລືອທ້າຍເດືອນ</th>
</tr>

<?php
$i = 1;
while ($item = mysql_fetch_array($SumResult)) {
	$whereGroupID = $item['tranID'];
?>
	<tr>
		<td class="centered"><?= ($i + $start) ?></td>
		<td>
			<div align="center"><strong><?= $item['traDate'] ?></strong></div>
		</td>
		<td>
			<div align="left"><strong><?= $item['reciever'] ?></strong></div>
		</td>
		<td>
			<div align="center"><strong><?= $item['username'] ?></strong></div>
		</td>
		<td>
			<div align="center"><strong><?= $item['date_add'] ?></strong></div>
		</td>
		<td colspan="3"><strong><?= $item['supplierName'] ?></td>
		<td colspan="4"><strong><?= $item['remark'] ?></td>
	</tr>
	<?php
	$j = 1;
	$sumPriceBill = 0;
	$sumDiscountBill = 0;
	$sumTotalPriceBill = 0;

	$result_detail = LoadTable($whereclause, $whereGroupID);
	//$sumTotalPrice = '0';
	while ($itemD = mysql_fetch_array($result_detail)) {
		$convert11 = 0;
		$convert12 = 0;
		$convert21 = 0;
		$convert22 = 0;
		$sumTotalPrice = $sumTotalPrice + (($itemD['pur_price'] - $itemD['receive_dis']) * $itemD['unitQty3']);
		$sumDiscount = $sumDiscount + ($itemD['receive_dis'] * $itemD['unitQty3']);
		$sumPrice = $sumPrice + ($itemD['pur_price'] * $itemD['unitQty3']);

		$sumTotalPriceBill = $sumTotalPriceBill + (($itemD['pur_price'] - $itemD['receive_dis']) * $itemD['unitQty3']);
		$sumDiscountBill = $sumDiscountBill + ($itemD['receive_dis'] * $itemD['unitQty3']);
		$sumPriceBill  = $sumPriceBill + ($itemD['pur_price']);

		if ($itemD['cap1'] != 0) {
			$convert11 = $itemD['unitQty3'] % $itemD['cap1'];
			$convert12 = ($itemD['unitQty3'] - ($convert11)) / $itemD['cap1'];
			$convert21 = $convert11 % $itemD['cap2'];
			$convert22 = ($convert11 - $convert21) / $itemD['cap2'];
		} else if ($itemD['cap2'] != 0) {
			$convert11 = 0;
			$convert12 = 0;
			$convert21 = $itemD['unitQty3'] % $itemD['cap2'];
			$convert22 = ($itemD['unitQty3'] - $convert21) / $itemD['cap2'];
		} else if ($itemD['cap3'] != 0) {
			$convert11 = 0;
			$convert12 = 0;
			$convert21 = $itemD['unitQty3'];
			$convert22 = 0;
		}

	?>
		<tr>
			<td class="centered"><?= ($i + $start) . '.' . $j ?></td>
			<td><?= $itemD['Typename'] ?></td>
			<td colspan="3"><?= $itemD['materialName'] ?></td>

			<td align="right"><?= number_format($convert12) . ' ' . $itemD['unitName1'] ?></td>
			<td align="right"><?= number_format($convert22) . ' ' . $itemD['unitName2'] ?></td>
			<td align="right"><?= number_format($convert21) . ' ' . $itemD['unitName3'] ?></td>
			<td align="right"><?= number_format($itemD['pur_price'] * $itemD['unitQty3']) ?></td>
			<td align="right"><?= number_format($itemD['receive_dis'] * $itemD['unitQty3']) ?></td>
			<td align="right"><?= number_format(($itemD['pur_price'] * $itemD['unitQty3']) - ($itemD['receive_dis'] * $itemD['unitQty3'])) ?></td>
			<td align="center"><?= $itemD['exp_date'] ?></td>
		</tr>

	<?php $j++;
	}  ?>
	<tr>
		<td colspan="8" align="center"><strong>ລວມມູນຄ່າ ວັນທີ <?= $item['date_add'] ?></strong></td>
		<td align="right"><strong> </strong></td>
		<td align="right"><strong><?= number_format($sumDiscountBill) ?></strong></td>
		<td align="right"><strong><?= number_format($sumTotalPriceBill) ?></strong></td>
		<td align="center"></td>
	</tr>

<?php $i++;
}  ?>
<tr>
	<td colspan="8" align="center"><strong>ລວມມູນຄ່າ ຮັບເຄື່ອງເຂົ້າສາງ ປະຈໍາວັນທີ່ <?= $_GET['startdate']  ?> - <?= $_GET['enddate']  ?></strong></td>
	<td align="right"><strong></strong></td>
	<td align="right"><strong><?= number_format($sumDiscount) ?></strong></td>
	<td align="right"><strong><?= number_format($sumTotalPrice) ?></strong></td>
	<td align="center"></td>
</tr>

</table>
<?php
mysql_close($conn);
?>